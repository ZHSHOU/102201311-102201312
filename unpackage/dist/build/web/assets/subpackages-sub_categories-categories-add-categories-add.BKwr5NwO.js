import{a1 as e,d as a,h as t,A as s,j as l,o,a as i,w as r,m as u,p as n,F as c,e as d,r as m,l as p,n as f,f as v,t as y,b as g,i as _,u as h,q as w,g as b,a3 as k,v as x,s as F,aA as C,$ as L,Y as T,a0 as P,J as z,c as N,X as j,W as D}from"./index-CzFVNye6.js";import{_ as I,a as U,b as R}from"./wd-form.CzoQC49t.js";import{r as S,a as A}from"./uni-app.es.xDvG45QC.js";import{_ as V}from"./wd-textarea.AEqGQim-.js";import{_ as E}from"./wd-icon.C3a6lim4.js";import{b as O,p as $,m as K,a as M,e as q,w as J,C as X,l as B,r as G,i as H}from"./props.Cxz2570m.js";import{u as W}from"./useTranslate.CXMl9qFr.js";import{_ as Y}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{_ as Q,a as Z}from"./wd-cell.CHbQx4mY.js";import{_ as ee}from"./wd-cell-group.CdBUPrJU.js";import"./types.DUQKCkIl.js";import"./useChildren.BEcQKJfk.js";const ae=Y(a({name:"wd-upload",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:{...O,fileList:$(),action:K(""),header:{type:Object,default:()=>{}},multiple:M(!1),disabled:M(!1),limit:q(0),showLimitNum:M(!0),maxSize:q(Number.MAX_VALUE),sourceType:$(),sizeType:$(),name:K("file"),formData:{type:Object,default:()=>{}},onPreviewFail:Function,beforeUpload:Function,beforeChoose:Function,beforeRemove:Function,beforePreview:Function,buildFormData:Function,loadingType:K("ring"),loadingColor:K("#ffffff"),accept:K("image"),statusKey:K("status"),useDefaultSlot:M(!1),loadingSize:K("24px"),customEvokeClass:K(""),customPreviewClass:K(""),imageMode:K("aspectFit")},emits:["fail","change","success","progress","oversize","chooseerror","remove"],setup(a,{emit:L}){const T=a,{translate:P}=W("upload"),z=t([]);s((()=>T.fileList),(e=>{const{statusKey:a}=T;if(J(e,z.value))return;const t=e.map((e=>(e.uid=X.id++,e[a]=e[a]||"success",e.action=T.action||"",e.response=e.response||"",e)));z.value=t}),{deep:!0,immediate:!0}),s((()=>T.limit),(e=>{e&&e<z.value.length&&console.error("[wot-design]Error: props limit must less than fileList.length")}),{deep:!0,immediate:!0}),s((()=>T.beforePreview),(e=>{e&&!B(e)&&"asyncfunction"!==G(e)&&console.error("The type of beforePreview must be Function")}),{deep:!0,immediate:!0}),s((()=>T.onPreviewFail),(e=>{e&&!B(e)&&"asyncfunction"!==G(e)&&console.error("The type of onPreviewFail must be Function")}),{deep:!0,immediate:!0}),s((()=>T.beforeRemove),(e=>{e&&!B(e)&&"asyncfunction"!==G(e)&&console.error("The type of beforeRemove must be Function")}),{deep:!0,immediate:!0}),s((()=>T.beforeUpload),(e=>{e&&!B(e)&&"asyncfunction"!==G(e)&&console.error("The type of beforeUpload must be Function")}),{deep:!0,immediate:!0}),s((()=>T.beforeChoose),(e=>{e&&!B(e)&&"asyncfunction"!==G(e)&&console.error("The type of beforeChoose must be Function")}),{deep:!0,immediate:!0}),s((()=>T.buildFormData),(e=>{e&&!B(e)&&"asyncfunction"!==G(e)&&console.error("The type of buildFormData must be Function")}),{deep:!0,immediate:!0});const N=L;function j(e,a,t){const{statusKey:s}=T,l=z.value.findIndex((e=>e.uid===a.uid));l>-1&&(z.value[l][s]="fail",z.value[l].error=e.message,z.value[l].response=e,N("fail",{error:e,file:a,formData:t}))}function D(e,a){const{action:t,name:s,header:l={},accept:o}=T;C({url:t,header:l,name:s,fileName:s,fileType:o,formData:a,filePath:e.url,success(t){200===t.statusCode?function(e,a,t){const{statusKey:s}=T,l=z.value.findIndex((e=>e.uid===a.uid));l>-1&&(z.value[l][s]="success",z.value[l].response=e.data,N("change",{fileList:z.value}),N("success",{file:a,fileList:z.value,formData:t}))}(t,e,a):j(t,e,a)},fail(t){j(t,e,a)}}).onProgressUpdate((a=>{!function(e,a){const t=z.value.findIndex((e=>e.uid===a.uid));t>-1&&(z.value[t].percent=e.progress,N("progress",{response:e,file:a}))}(a,e)}))}function U(){const{multiple:a,maxSize:t,accept:s,sizeType:l,limit:o,sourceType:i,beforeUpload:r}=T;"image"===s&&function({multiple:a,sizeType:t,sourceType:s,maxCount:l}){return new Promise(((o,i)=>{e({count:a?Math.min(l,9):1,sizeType:t,sourceType:s,success:o,fail:i})}))}({multiple:a,sizeType:l,sourceType:i,maxCount:o?o-z.value.length:9}).then((e=>{let s=Array.prototype.slice.call(e.tempFiles);a||(s=s.slice(0,1));const l=e=>{e.forEach((async e=>{var a;H(e.size)||(e.size=await(a=e.path,new Promise(((e,t)=>{k({src:a,success:a=>{e(a.height*a.width)},fail:()=>{t(0)}})})))),e.size<=t?function(e){const a={uid:X.id++,name:e.name||"",status:"loading",size:e.size,url:e.path,action:T.action,percent:0};z.value.push(a);const{buildFormData:t,formData:s={}}=T;t?t({file:a,formData:s,resolve:e=>{e&&D(a,e)}}):D(a,s)}(e):N("oversize",{file:e})}))};r?r({files:s,fileList:z.value,resolve:e=>{e&&l(s)}}):l(s)})).catch((e=>{N("chooseerror",{error:e})}))}function R(){if(T.disabled)return;const{beforeChoose:e}=T;e?e({fileList:z.value,resolve:e=>{e&&U()}}):U()}function A(e,a){z.value.splice(z.value.findIndex((a=>a.uid===e.uid)),1),N("change",{fileList:z.value}),N("remove",{file:e})}function V(e,a){const{onPreviewFail:t}=T;x({urls:a,current:a[e],fail(){t?t({index:e,imgList:a}):F({title:"预览图片失败",icon:"none"})}})}return(e,a)=>{const t=w,s=_,k=S(l("wd-loading"),I),x=b,F=S(l("wd-icon"),E);return o(),i(s,{class:f(["wd-upload",e.customClass]),style:g(e.customStyle)},{default:r((()=>[(o(!0),u(c,null,n(z.value,((a,l)=>(o(),i(s,{class:f(["wd-upload__preview",e.customPreviewClass]),key:l},{default:r((()=>[d(s,{class:"wd-upload__status-content"},{default:r((()=>[d(t,{src:a.url,mode:e.imageMode,class:"wd-upload__picture",onClick:e=>function(e){const{beforePreview:a}=T,t=z.value.map((e=>e.url));a?a({index:e,imgList:t,resolve:a=>{a&&V(e,t)}}):V(e,t)}(l)},null,8,["src","mode","onClick"])])),_:2},1024),"success"!==a.status?(o(),i(s,{key:0,class:"wd-upload__mask wd-upload__status-content"},{default:r((()=>["loading"===a.status?(o(),i(s,{key:0,class:"wd-upload__status-content"},{default:r((()=>[d(k,{type:e.loadingType,size:e.loadingSize,color:e.loadingColor},null,8,["type","size","color"]),d(x,{class:"wd-upload__progress-txt"},{default:r((()=>[v(y(a.percent)+"%",1)])),_:2},1024)])),_:2},1024)):p("",!0),"fail"===a.status?(o(),i(s,{key:1,class:"wd-upload__status-content"},{default:r((()=>[d(F,{name:"close-outline","custom-class":"wd-upload__icon"}),d(x,{class:"wd-upload__progress-txt"},{default:r((()=>[v(y(a.error||h(P)("error")),1)])),_:2},1024)])),_:2},1024)):p("",!0)])),_:2},1024)):p("",!0),"loading"===a.status||e.disabled?p("",!0):(o(),i(F,{key:1,name:"error-fill","custom-class":"wd-upload__close",onClick:e=>function(e){const{beforeRemove:a}=T,t=e,s=z.value[t];a?a({file:s,index:t,fileList:z.value,resolve:e=>{e&&A(s)}}):A(s)}(l)},null,8,["onClick"]))])),_:2},1032,["class"])))),128)),d(s,{onClick:R},{default:r((()=>[e.useDefaultSlot?m(e.$slots,"default",{key:0},void 0,!0):p("",!0),e.useDefaultSlot||e.limit&&!(z.value.length<e.limit)?p("",!0):(o(),i(s,{key:1,class:f(["wd-upload__evoke",e.disabled?"is-disabled":"",e.customEvokeClass])},{default:r((()=>[d(F,{class:"wd-upload__evoke-icon",name:"fill-camera"}),e.limit&&e.showLimitNum?(o(),i(s,{key:0,class:"wd-upload__evoke-num"},{default:r((()=>[v("（"+y(z.value.length)+"/"+y(e.limit)+"）",1)])),_:1})):p("",!0)])),_:1},8,["class"]))])),_:3})])),_:3},8,["class","style"])}}}),[["__scopeId","data-v-56b46c46"]]),te=a({__name:"custom-upload",setup(e,{expose:a}){const s=t([]),u=e=>{L({title:"上传中...",mask:!0}),e.files.map((async e=>{let a=e.path.substring(e.path.lastIndexOf("/")+1);a+=e.name;try{let{fileID:t}=await T.uploadFile({filePath:e.path,cloudPath:`cloudstorage/${a}`,cloudPathAsRealPath:!0,fileType:"image"});const l=await T.getTempFileURL({fileList:[t]});console.log(l,"上传后的tempRes"),s.value.push({url:l.fileList[0].tempFileURL}),P()}catch(t){P(),console.log("图片上传失败---",t)}}))},n=({index:e})=>{s.value.splice(e,1)};return a({fileList:s,updateFileList:e=>{s.value=e}}),(e,a)=>{const t=S(l("wd-upload"),ae),c=_;return o(),i(c,null,{default:r((()=>[d(t,{"file-list":s.value,action:"#",limit:5,"before-upload":u,"before-remove":n},null,8,["file-list"])])),_:1})}}}),se=Y(a({__name:"categories-add",setup(e){const a=T.database(),s=t(""),u=z({categoryName:"",remark:""}),n=t(),c=t(),m=t(!1),p={categoryName:[{required:!0,message:"请输入分类名称",validator:e=>e?Promise.resolve():Promise.reject("请输入分类名称")}]},f=N((()=>!(!m.value&&u.categoryName))),y=()=>{c.value.validate().then((async({valid:e})=>{e&&(m.value=!0,await a.collection("travel-classify").where(`categoryName == "${u.categoryName}" && user_id == $cloudEnv_uid && delete_status == 1`).get().then((e=>{const a=e.result.data;return a.length?s.value&&a[0]._id===s.value?void g():(m.value=!1,F({title:"当前分类名称已存在！",icon:"none"})):g()})).catch((e=>(m.value=!1,F({title:"保存失败，请联系管理员",icon:"none"})))))}))},g=()=>{let e=n.value.fileList.map((e=>({url:e.url})));const t={categoryName:u.categoryName,remark:u.remark,fileList:e},l=a.collection("travel-classify");(s.value?l.doc(s.value).update(t):l.add(t)).then((e=>{console.log("==== 分类",e),F({title:s.value?"更新成功":"保存成功",icon:"none"}),setTimeout((()=>{m.value=!1,D({url:"/pages/categories/categories"})}),1500)})).catch((e=>{m.value=!1,F({title:"保存失败，请联系管理员",icon:"none"})}))};return A((e=>{(null==e?void 0:e.id)&&(s.value=null==e?void 0:e.id,a.collection("travel-classify").doc(s.value).get({getOne:!0}).then((e=>{if(0===e.result.errCode){const{categoryName:a,remark:t,fileList:s}=e.result.data;u.categoryName=a,u.remark=t,n.value.updateFileList(s)}})).catch((()=>{F({title:"系统错误，请联系管理员",icon:"none"}),setTimeout((()=>{j()}),1500)})))})),(e,a)=>{const t=S(l("wd-input"),U),s=S(l("wd-textarea"),V),m=S(l("custom-upload"),te),g=S(l("wd-cell"),Q),h=S(l("wd-cell-group"),ee),w=S(l("wd-button"),Z),b=_,k=S(l("wd-form"),R);return o(),i(b,null,{default:r((()=>[d(k,{ref_key:"form",ref:c,model:u,rules:p},{default:r((()=>[d(h,{"custom-class":"group",title:"基础信息",border:""},{default:r((()=>[d(t,{label:"分类名称","label-width":"100px",maxlength:20,"show-word-limit":"",prop:"categoryName",required:"",clearable:"",modelValue:u.categoryName,"onUpdate:modelValue":a[0]||(a[0]=e=>u.categoryName=e),placeholder:"请输入分类名称"},null,8,["modelValue"]),d(s,{label:"备注","label-width":"100px",type:"textarea",modelValue:u.remark,"onUpdate:modelValue":a[1]||(a[1]=e=>u.remark=e),maxlength:300,"show-word-limit":"",placeholder:"请输入备注信息",clearable:""},null,8,["modelValue"]),d(g,{title:"轮播图","title-width":"100px"},{default:r((()=>[d(m,{ref_key:"uploadComp",ref:n},null,512)])),_:1})])),_:1}),d(b,{class:"footer"},{default:r((()=>[d(w,{type:"primary",size:"large",disabled:f.value,onClick:y,block:""},{default:r((()=>[v("保存")])),_:1},8,["disabled"])])),_:1})])),_:1},8,["model"])])),_:1})}}}),[["__scopeId","data-v-91fdc248"]]);export{se as default};
