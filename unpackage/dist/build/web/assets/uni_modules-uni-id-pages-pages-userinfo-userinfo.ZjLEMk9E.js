import{Y as e,o as i,a as t,w as s,b as a,l as o,q as n,i as l,U as r,$ as c,a0 as u,N as d,a1 as h,j as p,n as m,Q as f,a2 as g,e as y,f as b,g as w,z as _,s as k}from"./index-CzFVNye6.js";import{_ as v}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{r as I}from"./uni-app.es.xDvG45QC.js";import{_ as C}from"./uni-icons.DoyIsjdl.js";import{s as x,m as S}from"./store.DJP51awm.js";import{_ as M,a as P}from"./uni-list.DaS_ed9a.js";import{_ as L}from"./uni-popup-dialog.BttFfv5t.js";import{_ as B}from"./uni-popup.DDTIRvxY.js";const T=v({name:"cloud-image",emits:["click"],props:{mode:{type:String,default:()=>"widthFix"},src:{default:()=>""},width:{type:String,default:()=>"100rpx"},height:{type:String,default:()=>"100rpx"}},watch:{src:{handler(i){i&&"cloud://"==i.substring(0,8)?e.getTempFileURL({fileList:[i]}).then((e=>{this.cSrc=e.fileList[0].tempFileURL})):this.cSrc=i},immediate:!0}},methods:{onClick(){this.$emit("click")}},data:()=>({cSrc:!1})},[["render",function(e,r,c,u,d,h){const p=n,m=l;return i(),t(m,{onClick:h.onClick,style:a([{width:c.width,height:c.height},{"justify-content":"center"}])},{default:s((()=>[d.cSrc?(i(),t(p,{key:0,style:a({width:c.width,height:c.height}),src:d.cSrc,mode:c.mode},null,8,["style","src","mode"])):o("",!0)])),_:1},8,["onClick","style"])}]]);const U=v({data:()=>({isPC:!1}),props:{width:{type:String,default:()=>"50px"},height:{type:String,default:()=>"50px"},border:{type:Boolean,default:()=>!1}},async mounted(){this.isPC=!["ios","android"].includes(r().platform)},computed:{hasLogin:()=>x.hasLogin,userInfo:()=>x.userInfo,avatar_file:()=>x.userInfo.avatar_file},methods:{setAvatarFile(e){S.updateUserInfo({avatar_file:e})},async bindchooseavatar(i){let t=i.detail.avatarUrl,s={extname:t.split(".")[t.split(".").length-1],name:"",url:""},a=this.userInfo._id+""+Date.now();s.name=a;try{c({title:"更新中",mask:!0});let{fileID:i}=await e.uploadFile({filePath:t,cloudPath:a,fileType:"image"});const o=await e.getTempFileURL({fileList:[i]});s.url=o.fileList[0].tempFileURL,u()}catch(o){console.error(o)}console.log("avatar_file",s),this.setAvatarFile(s)},uploadAvatarImg(i){if(!this.hasLogin)return d({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"});const t={quality:100,width:600,height:600,resize:!0};h({count:1,crop:t,success:async i=>{let s=i.tempFiles[0],a={extname:s.name.split(".")[s.name.split(".").length-1]},o=i.tempFilePaths[0];this.isPC||(o=await new Promise((e=>{d({url:"/uni_modules/uni-id-pages/pages/userinfo/cropImage/cropImage?path="+o+`&options=${JSON.stringify(t)}`,animationType:"fade-in",events:{success:i=>{e(i)}},complete(e){console.log(e)}})})));let n="cloudstorage/"+this.userInfo._id+Date.now();a.name=n,c({title:"更新中",mask:!0});let{fileID:l}=await e.uploadFile({filePath:o,cloudPath:n,cloudPathAsRealPath:!0,fileType:"image"});a.url=l,u(),this.setAvatarFile(a)}})}}},[["render",function(e,o,n,l,r,c){const u=I(p("cloud-image"),T),d=I(p("uni-icons"),C),h=f;return i(),t(h,{"open-type":"chooseAvatar",onChooseavatar:c.bindchooseavatar,onClick:c.uploadAvatarImg,class:m(["box",{showBorder:n.border}]),style:a({width:n.width,height:n.height,lineHeight:n.height})},{default:s((()=>[c.avatar_file?(i(),t(u,{key:0,src:c.avatar_file.url,width:n.width,height:n.height},null,8,["src","width","height"])):(i(),t(d,{key:1,style:a({width:n.width,height:n.height,lineHeight:n.height}),class:"chooseAvatar",type:"plusempty",size:"30",color:"#dddddd"},null,8,["style"]))])),_:1},8,["onChooseavatar","onClick","class","style"])}],["__scopeId","data-v-2d0eb1fd"]]);e.database().collection("uni-id-users");const j=e.importObject("uni-id-co");const A=v({emits:["success"],computed:{},data:()=>({}),methods:{beforeGetphonenumber:async()=>await new Promise(((i,t)=>{c({mask:!0}),wx.checkSession({success(){i(),u()},fail(){g({success({code:s}){e.importObject("uni-id-co",{customUI:!0}).loginByWeixin({code:s}).then((e=>{i()})).catch((e=>{console.log(e),t()})).finally((e=>{u()}))},fail:e=>{console.error(e),t()}})}})})),async bindMobileByMpWeixin(e){"getPhoneNumber:ok"==e.detail.errMsg?(await this.beforeGetphonenumber(),j.bindMobileByMpWeixin(e.detail).then((e=>{this.$emit("success")})).finally((e=>{this.closeMe()}))):this.closeMe()},async open(){this.$refs.popup.open()},closeMe(e){this.$refs.popup.close()}}},[["render",function(e,a,o,n,r,c){const u=w,d=f,h=l,m=I(p("uni-popup"),B);return i(),t(m,{ref:"popup",type:"bottom"},{default:s((()=>[y(h,{class:"box"},{default:s((()=>[y(u,{class:"headBox"},{default:s((()=>[b("绑定资料")])),_:1}),y(u,{class:"tip"},{default:s((()=>[b("将一键获取你的手机号码绑定你的个人资料")])),_:1}),y(h,{class:"btnBox"},{default:s((()=>[y(u,{onClick:c.closeMe,class:"close"},{default:s((()=>[b("关闭")])),_:1},8,["onClick"]),y(d,{class:"agree uni-btn",type:"primary","open-type":"getPhoneNumber",onGetphonenumber:c.bindMobileByMpWeixin},{default:s((()=>[b("获取")])),_:1},8,["onGetphonenumber"])])),_:1})])),_:1})])),_:1},512)}],["__scopeId","data-v-1edc5089"]]),N=e.importObject("uni-id-co");const F=v({computed:{userInfo:()=>x.userInfo,realNameStatus(){return this.userInfo.realNameAuth?this.userInfo.realNameAuth.authStatus:0}},data:()=>({univerifyStyle:{authButton:{title:"本机号码一键绑定"},otherLoginButton:{title:"其他号码绑定"}},hasPwd:!1,showLoginManage:!1,setNicknameIng:!1}),async onShow(){this.univerifyStyle.authButton.title="本机号码一键绑定",this.univerifyStyle.otherLoginButton.title="其他号码绑定"},async onLoad(e){e.showLoginManage&&(this.showLoginManage=!0);let i=await N.getAccountInfo();this.hasPwd=i.isPasswordSet},methods:{login(){d({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd",complete:e=>{}})},logout(){_({content:"是否确认退出？",success(e){e.confirm&&S.logout()}})},bindMobileSuccess(){S.updateUserInfo()},changePassword(){d({url:"/uni_modules/uni-id-pages/pages/userinfo/change_pwd/change_pwd",complete:e=>{}})},bindMobile(){this.bindMobileBySmsCode()},univerify(){g({provider:"univerify",univerifyStyle:this.univerifyStyle,success:async e=>{N.bindMobileByUniverify(e.authResult).then((e=>{S.updateUserInfo()})).catch((e=>{console.log(e)})).finally((e=>{uni.closeAuthView()}))},fail:e=>{console.log(e),"30002"!=e.code&&"30001"!=e.code||this.bindMobileBySmsCode()}})},bindMobileBySmsCode(){d({url:"./bind-mobile/bind-mobile"})},setNickname(e){e?(S.updateUserInfo({nickname:e}),this.setNicknameIng=!1,this.$refs.dialog.close()):this.$refs.dialog.open()},deactivate(){d({url:"/uni_modules/uni-id-pages/pages/userinfo/deactivate/deactivate"})},async bindThirdAccount(i){const t=e.importObject("uni-id-co"),s={weixin:"wx_openid",alipay:"ali_openid",apple:"apple_openid",qq:"qq_openid"}[i.toLowerCase()];this.userInfo[s]?(await t["unbind"+i](),await S.updateUserInfo()):g({provider:i.toLowerCase(),onlyAuthorize:!0,success:async e=>{const s=await t["bind"+i]({code:e.code});s.errCode&&k({title:s.errMsg||"绑定失败",duration:3e3}),await S.updateUserInfo()},fail:async e=>{console.log(e),u()}})},realNameVerify(){d({url:"/uni_modules/uni-id-pages/pages/userinfo/realname-verify/realname-verify"})}}},[["render",function(e,a,n,r,c,u){const d=I(p("uni-id-pages-avatar"),U),h=l,m=I(p("uni-list-item"),M),f=I(p("uni-list"),P),g=I(p("uni-popup-dialog"),L),b=I(p("uni-popup"),B),w=I(p("uni-id-pages-bind-mobile"),A);return i(),t(h,{class:"uni-content"},{default:s((()=>[y(h,{class:"avatar"},{default:s((()=>[y(d,{width:"260rpx",height:"260rpx"})])),_:1}),y(f,null,{default:s((()=>[y(m,{class:"item",onClick:a[0]||(a[0]=e=>u.setNickname("")),title:"学号姓名",rightText:u.userInfo.nickname||"未设置",link:""},null,8,["rightText"]),y(m,{class:"item",onClick:u.bindMobile,title:"手机号",rightText:u.userInfo.mobile||"未绑定",link:""},null,8,["onClick","rightText"]),u.userInfo.email?(i(),t(m,{key:0,class:"item",title:"电子邮箱",rightText:u.userInfo.email},null,8,["rightText"])):o("",!0),c.hasPwd?(i(),t(m,{key:1,class:"item",onClick:u.changePassword,title:"修改密码",link:""},null,8,["onClick"])):o("",!0),y(m,{class:"item",onClick:u.logout,title:"退出登录",link:""},null,8,["onClick"])])),_:1}),y(f,{class:"mt10"},{default:s((()=>[y(m,{onClick:u.deactivate,title:"注销账号",link:"navigateTo"},null,8,["onClick"])])),_:1}),y(b,{ref:"dialog",type:"dialog"},{default:s((()=>[y(g,{mode:"input",value:u.userInfo.nickname,onConfirm:u.setNickname,inputType:c.setNicknameIng?"nickname":"text",title:"设置学号姓名",placeholder:"请输入要设置的学号姓名"},null,8,["value","onConfirm","inputType"])])),_:1},512),y(w,{ref:"bind-mobile-by-sms",onSuccess:u.bindMobileSuccess},null,8,["onSuccess"])])),_:1})}],["__scopeId","data-v-82fe848e"]]);export{F as default};
